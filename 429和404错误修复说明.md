# 🔧 429 和 404 错误修复说明

## ❌ 问题

Google 后台收到了 API 请求，但返回了：
- **404 NotFound** - 模型名称不正确
- **429 TooManyRequests** - 请求频率过高，触发速率限制

## ✅ 修复内容

### 1. 429 错误处理（速率限制）

#### 添加了重试机制和指数退避

- **自动重试**: 遇到 429 错误时，自动重试最多 3 次
- **指数退避**: 每次重试的延迟时间递增（2秒 → 4秒 → 8秒）
- **尊重 Retry-After**: 如果 API 返回 `Retry-After` 头，会使用该值
- **模型切换**: 如果某个模型遇到 429，自动尝试下一个模型

#### 工作流程

```
请求 → 429 错误 → 等待 2 秒 → 重试
     → 429 错误 → 等待 4 秒 → 重试
     → 429 错误 → 等待 8 秒 → 重试
     → 如果仍然失败，尝试下一个模型
```

### 2. 404 错误处理（模型不存在）

#### 改进的模型选择策略

- **优先使用实际可用模型**: 先查询 Google API 获取可用模型列表
- **模型列表缓存**: 缓存模型列表 1 小时，避免频繁查询
- **智能回退**: 如果查询失败，使用默认模型列表
- **多模型尝试**: 按顺序尝试多个模型，直到找到可用的

#### 模型尝试顺序

1. 用户指定的模型（`GEMINI_MODEL` 环境变量）
2. 从 Google API 查询到的可用模型（前 3 个）
3. `gemini-1.5-flash`
4. `gemini-1.5-pro`
5. `gemini-pro`
6. `gemini-1.5-flash-latest`
7. `gemini-1.5-pro-latest`

### 3. 性能优化

- **模型列表缓存**: 避免每次请求都查询可用模型
- **缓存时间**: 1 小时（3600000 毫秒）
- **减少 API 调用**: 降低触发速率限制的风险

## 📋 功能说明

### 重试机制 (`retryWithBackoff`)

```javascript
// 自动处理 429 错误
await this.retryWithBackoff(async () => {
  return await axios.post(url, data, config);
}, 3, 2000); // 最多重试3次，基础延迟2秒
```

**特点**:
- 只对 429 错误进行重试
- 其他错误立即抛出
- 指数退避策略
- 支持 `Retry-After` 头

### 模型列表缓存 (`getAvailableModels`)

```javascript
// 获取可用模型（带缓存）
const models = await this.getAvailableModels();
```

**特点**:
- 首次调用时查询 Google API
- 结果缓存 1 小时
- 缓存失效后自动更新
- 查询失败时使用默认模型

## 🎯 使用建议

### 1. 降低请求频率

如果经常遇到 429 错误：

- **增加请求间隔**: 在工具页面添加防抖或节流
- **减少并发请求**: 确保同一时间只有一个请求
- **使用队列**: 对请求进行排队处理

### 2. 配置模型（可选）

如果想指定特定模型，在 Vercel 环境变量中设置：

```
GEMINI_MODEL=gemini-1.5-flash
```

### 3. 监控 API 使用

- 定期查看 Google Cloud Console 中的 API 使用情况
- 检查是否有配额限制
- 考虑升级 API 配额（如果需要）

## 🔍 日志说明

### 成功日志

```
✅ GOOGLE_API_KEY is configured (format looks correct)
📋 Found 5 available models: gemini-1.5-flash, gemini-1.5-pro, ...
✅ Successfully used Gemini model: gemini-1.5-flash with API v1beta
```

### 429 错误日志

```
⏳ Rate limit hit (429), waiting 2000ms before retry 1/3
⚠️ Rate limit (429) for model gemini-1.5-flash, trying next model...
```

### 404 错误日志

```
⚠️ Model gemini-pro with API v1beta not found (404), trying next...
```

## 📊 错误处理流程

```
请求开始
  ↓
尝试模型 1 + API v1beta
  ↓
404? → 尝试下一个模型
429? → 重试（带退避）→ 仍然失败？→ 尝试下一个模型
其他错误? → 记录并尝试下一个
  ↓
所有模型都失败？
  ↓
抛出详细错误信息
```

## ✅ 验证

部署后，测试以下场景：

### 测试 1: 正常请求

- 访问工具页面
- 提交请求
- 应该成功生成内容

### 测试 2: 速率限制

- 快速连续提交多个请求
- 应该看到重试日志
- 最终应该成功（在重试后）

### 测试 3: 模型选择

- 查看 Vercel 日志
- 应该看到 `📋 Found X available models`
- 应该看到 `✅ Successfully used Gemini model: ...`

## 🚀 部署

修复已包含在代码中，只需：

1. **等待自动部署**（如果已推送）
2. **或手动触发部署**
3. **测试工具功能**

## 📝 技术细节

### 指数退避算法

```javascript
delay = baseDelay * (2 ^ attempt)
// attempt 0: 2000ms
// attempt 1: 4000ms
// attempt 2: 8000ms
```

### 缓存策略

- **缓存键**: `availableModelsCache`
- **缓存时间**: 1 小时
- **失效条件**: 时间超过 1 小时或查询失败

### 重试策略

- **最大重试次数**: 3 次
- **基础延迟**: 2 秒
- **适用错误**: 仅 429 错误
- **其他错误**: 立即抛出

---

**修复已完成！系统现在可以自动处理 429 和 404 错误。** 🎉

